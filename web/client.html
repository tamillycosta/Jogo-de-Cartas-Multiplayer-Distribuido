<!DOCTYPE html>
<html>
<head>
  <title>Test WebSocket</title>
</head>
<body>
  <h1>WebSocket Test</h1>
  
  <input type="text" id="usernameInput" placeholder="Nome de utilizador" value="joao123">
  
  <button id="createBtn">Criar Conta</button>
  <button id="loginBtn">Login</button>
  <button id="logoutBtn">Logout</button>
  <div id="log"></div>

  <script>
    let socket;
    let clientID;
    const logDiv = document.getElementById('log');
    const usernameInput = document.getElementById('usernameInput');

    // L칍GICA DIN츽MICA: Descobre o endere칞o do servidor a partir do URL da p치gina
    const wsHost = window.location.host; // ex: "localhost:8081"
    const wsURL = `ws://${wsHost}/ws`;
    logDiv.innerHTML += `<p>A ligar a: ${wsURL}</p>`;

    //  CONECTAR com o endere칞o din칙mico
    socket = new WebSocket(wsURL);

    //  ESPERAR CONEX츾O ABRIR
    socket.onopen = () => {
      console.log(' Conectado!');
      logDiv.innerHTML += '<p> Conectado!</p>';
    };

    //  RECEBER MENSAGENS
    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      console.log('Recebido:', data);
      logDiv.innerHTML += `<p> ${JSON.stringify(data)}</p>`;

      if (data.type === 'connected') {
        clientID = data.client_id;
        console.log(' Client ID:', clientID);
        
        socket.send(JSON.stringify({
          type: 'subscribe',
          topic: `auth.response.${clientID}`
        }));
      }
    };

    socket.onerror = (e) => {
      console.error(' Erro:', e);
      logDiv.innerHTML += '<p> Erro na conex칚o</p>';
    };

    socket.onclose = () => {
      console.log(' Desconectado');
      logDiv.innerHTML += '<p>游댋 Desconectado</p>';
    };

    // ENVIAR MENSAGEM (s칩 depois de conectar!)
    document.getElementById('createBtn').onclick = () => {
      if (socket.readyState !== WebSocket.OPEN) {
        alert(' WebSocket n칚o est치 conectado!');
        return;
      }
      
      const username = usernameInput.value;
      if (!username) {
        alert('Por favor, insira um nome de utilizador.');
        return;
      }

      socket.send(JSON.stringify({
        type: 'publish',
        topic: 'auth.create_account',
        data: { username: username }
      }));

      console.log(`Enviado: criar conta para ${username}`);
      logDiv.innerHTML += `<p>Criando conta para ${username}...</p>`;
    };

     document.getElementById('loginBtn').onclick = () => {
      if (socket.readyState !== WebSocket.OPEN) {
        alert(' WebSocket n칚o est치 conectado!');
        return;
      }

      const username = usernameInput.value;
      if (!username) {
        alert('Por favor, insira um nome de utilizador.');
        return;
      }

      socket.send(JSON.stringify({
        type: 'publish',
        topic: 'auth.login',
        data: { username: username }
      }));

      console.log(`Enviado: login para ${username}`);
      logDiv.innerHTML += `<p>Fazendo login para ${username}...</p>`;
    };

    document.getElementById('logoutBtn').onclick = () => {
      if (socket.readyState !== WebSocket.OPEN) {
        alert(' WebSocket n칚o est치 conectado!');
        return;
      }
      
      socket.send(JSON.stringify({
        type: 'publish',
        topic: 'auth.logout',
        data: {}
      }));

      console.log('Enviado: logout');
      logDiv.innerHTML += '<p>A fazer logout...</p>';
    };
    
  </script>
</body>
</html>
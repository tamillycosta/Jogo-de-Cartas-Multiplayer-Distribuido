<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test WebSocket</title>
  <style>
    body { font-family: system-ui, Arial; padding: 12px; }
    #log { margin-top: 12px; white-space: pre-wrap; background:#f6f6f6; padding:8px; border-radius:6px; max-height:300px; overflow:auto; }
    button { margin-right:6px; }
  </style>
</head>
<body>
  <h1>WebSocket Test</h1>

  <label>
    Nome de utilizador:
    <input type="text" id="usernameInput" placeholder="Nome de utilizador" value="joao123">
  </label>
  <div style="margin-top:8px;">
    <button id="createBtn">Criar Conta</button>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn">Logout</button>
    <button id="openPackBtn">Abrir Pacote</button>
  </div>

  <div id="log"></div>

  <script>
    let socket;
    let clientID = null;
    let playerID = null;
    const logDiv = document.getElementById('log');
    const usernameInput = document.getElementById('usernameInput');

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${now}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    const wsURL = `ws://localhost:8080/ws`;
    log(`Ligando a: ${wsURL}`);
    socket = new WebSocket(wsURL);

    socket.onopen = () => log('Conectado ao servidor WebSocket.');

    socket.onmessage = (event) => {
      let data;
      try {
        data = JSON.parse(event.data);
      } catch (e) {
        log(`Mensagem recebida (não JSON): ${event.data}`);
        return;
      }

      log(`Recebido: ${JSON.stringify(data)}`);

      // Identifica o client_id
      if (data.type === 'connected' && data.client_id) {
        clientID = data.client_id;
        log(`Client ID recebido: ${clientID}`);

        socket.send(JSON.stringify({ type: 'subscribe', topic: `auth.response.${clientID}` }));
        socket.send(JSON.stringify({ type: 'subscribe', topic: `package.response.${clientID}` }));
        return;
      }

      // Trata payloads com campo data
      if (data.data && typeof data.data === 'object') {
        const payload = data.data;

        // pega o ID corretamente dentro de player.id
        if (payload.player && payload.player.id) {
          playerID = payload.player.id;
          log(`player_id recebido do servidor: ${playerID}`);
        }

        // Caso seja resposta de login
        if (payload.type && payload.type.toLowerCase().includes('login') && payload.success === true) {
          if (payload.player && payload.player.id) {
            playerID = payload.player.id;
            log(`Login confirmado — player_id: ${playerID}`);
          } else {
            log('Login confirmado, mas servidor não retornou player_id no payload.');
          }
        }
      }

      // Caso venha direto no topo (fallback)
      if (data.player_id && typeof data.player_id === 'string') {
        playerID = data.player_id;
        log(`player_id recebido (top-level): ${playerID}`);
      }
    };

    socket.onerror = (e) => {
      console.error(e);
      log('Erro na conexão WebSocket (veja console).');
    };

    socket.onclose = () => log('Conexão WebSocket fechada.');

    function isReady() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('WebSocket não está conectado!');
        return false;
      }
      return true;
    }

    // --- Botões ---
    document.getElementById('createBtn').onclick = () => {
      if (!isReady()) return;
      const username = usernameInput.value.trim();
      if (!username) return alert('Insira um nome de utilizador.');
      socket.send(JSON.stringify({ type: 'publish', topic: 'auth.create_account', data: { username } }));
      log(`Solicitado: criar conta para "${username}"`);
    };

    document.getElementById('loginBtn').onclick = () => {
      if (!isReady()) return;
      const username = usernameInput.value.trim();
      if (!username) return alert('Insira um nome de utilizador.');
      socket.send(JSON.stringify({ type: 'publish', topic: 'auth.login', data: { username } }));
      log(`Solicitado: login para "${username}"`);
    };

    document.getElementById('logoutBtn').onclick = () => {
      if (!isReady()) return;
      socket.send(JSON.stringify({ type: 'publish', topic: 'auth.logout', data: {} }));
      playerID = null;
      log('Solicitado: logout (playerID local limpo).');
    };

    document.getElementById('openPackBtn').onclick = () => {
      if (!isReady()) return;

      if (!playerID) {
        alert('Não tens um player_id válido. Faz login primeiro (o servidor devolve o player_id).');
        return;
      }

      socket.send(JSON.stringify({
        type: 'publish',
        topic: 'package.open_pack',
        data: { player_id: playerID }
      }));

      log(`Solicitado: abrir pacote para player_id="${playerID}"`);
    };
  </script>
</body>
</html>

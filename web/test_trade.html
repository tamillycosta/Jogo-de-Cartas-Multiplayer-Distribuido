<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Teste WebSocket - Troca de Cartas</title>
  <style>
    body { font-family: system-ui, Arial; padding: 12px; display: flex; gap: 20px;}
    .container { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
    #log { margin-top: 12px; white-space: pre-wrap; background:#f6f6f6; padding:8px; border-radius:6px; height: 400px; width: 400px; overflow:auto; font-size: 0.9em;}
    button { margin-right:6px; margin-top: 5px; padding: 5px 10px;}
    input[type=text] { margin-bottom: 8px; padding: 4px; width: 200px; }
    label { display: block; margin-bottom: 2px; font-weight: bold;}
    hr { margin: 15px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Teste WebSocket</h1>

    <label for="usernameInput">Nome de utilizador:</label>
    <input type="text" id="usernameInput" placeholder="Nome de utilizador" value="jogadorA">

    <div style="margin-top:8px;">
      <button id="createBtn">Criar Conta</button>
      <button id="loginBtn">Login</button>
      <button id="logoutBtn">Logout</button>
      <button id="openPackBtn" title="Funcionalidade de abrir pacote">Abrir Pacote</button>
    </div>

    <hr>

    <h2>Trocar Cartas</h2>
    <p><i>Faça login primeiro. Obtenha IDs do banco de dados.</i></p>

    <label for="cardAInput">Sua Carta ID (A):</label>
    <input type="text" id="cardAInput" placeholder="ID da carta a dar">

    <label for="playerBInput">ID do Jogador B:</label>
    <input type="text" id="playerBInput" placeholder="ID do outro jogador">

    <label for="cardBInput">Carta Desejada ID (B):</label>
    <input type="text" id="cardBInput" placeholder="ID da carta a receber">

    <div>
        <button id="tradeBtn">Solicitar Troca</button>
    </div>

  </div>

  <div class="container">
    <h2>Log de Mensagens</h2>
    <div id="log"></div>
  </div>

  <script>
    let socket;
    let clientID = null;
    let playerID = null; // Armazenar o ID do jogador após login
    const logDiv = document.getElementById('log');
    const usernameInput = document.getElementById('usernameInput');
    const cardAInput = document.getElementById('cardAInput');
    const playerBInput = document.getElementById('playerBInput');
    const cardBInput = document.getElementById('cardBInput');

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${now}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll
    }

    // Lógica dinâmica para conectar ao servidor correto baseado no URL
    const wsHost = window.location.host; // ex: "localhost:8080" ou "localhost:8081"
    const wsURL = `ws://${wsHost}/ws`;
    log(`Tentando ligar a: ${wsURL}`);

    socket = new WebSocket(wsURL);

    socket.onopen = () => log('Conectado ao servidor WebSocket.');

    socket.onmessage = (event) => {
      let messageData;
      try {
        messageData = JSON.parse(event.data);
      } catch (e) {
        log(`Mensagem recebida (não JSON): ${event.data}`);
        return;
      }

      log(`Recebido: ${JSON.stringify(messageData)}`);

      // Identifica o client_id na conexão inicial
      if (messageData.type === 'connected' && messageData.client_id) {
        clientID = messageData.client_id;
        log(`Client ID recebido: ${clientID}`);

        // Inscreve-se nos tópicos de resposta necessários
        subscribeToTopic(`auth.response.${clientID}`);
        subscribeToTopic(`package.response.${clientID}`);
        subscribeToTopic(`trade.response.${clientID}`); // Inscrever na resposta de trade
        return;
      }

      // Trata mensagens publicadas em tópicos (que têm um campo 'data' aninhado)
      if (messageData.data && typeof messageData.data === 'object') {
        const payload = messageData.data; // O conteúdo real está dentro de 'data'

        // Extrai Player ID da resposta de login bem-sucedida
        if (payload.type && payload.type.toLowerCase().includes('login') && payload.success === true) {
          if (payload.player && payload.player.id) {
            playerID = payload.player.id;
            log(`Login bem-sucedido! Player ID: ${playerID}`);
          } else {
            log('Login confirmado, mas servidor não retornou player.id no payload.');
          }
        }

         // Feedback extra para respostas de trade e pacote
         if (payload.type === 'trade_requested' || payload.type === 'trade_error') {
             log(`Resposta da Troca: ${payload.message || payload.error}`);
         }

         if (payload.type === 'package_opened' || (payload.type === 'package.open_pack' && payload.success === false) ) { // Corrigido para erro tbm
             log(`Resposta Abrir Pacote: ${payload.message || payload.error}`);
         }
      }
    };

    socket.onerror = (error) => {
      console.error('WebSocket Error:', error);
      log('Erro na conexão WebSocket (ver console).');
    };

    socket.onclose = (event) => {
      log(`Conexão WebSocket fechada. Código: ${event.code}, Motivo: ${event.reason || 'N/A'}`);
      clientID = null;
      playerID = null; // Limpa o player ID na desconexão
    };

    // Função auxiliar para verificar se está pronto
    function isReady(requireLogin = false) {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert('WebSocket não está conectado!');
        return false;
      }
       if (requireLogin && !playerID) {
           alert('É preciso fazer login primeiro para obter o Player ID!');
           return false;
       }
      return true;
    }

     // Função auxiliar para enviar mensagens PUBLISH que REQUEREM LOGIN
     function sendAuthMessage(topic, data) {
         if (!isReady(true)) { // Garante que está conectado E logado
             return;
         }
         const message = { type: 'publish', topic, data };
         socket.send(JSON.stringify(message));
         log(`Enviado (${topic}): ${JSON.stringify(data || {})}`);
     }

    // Função para inscrever em tópico
    function subscribeToTopic(topic) {
        if (!socket || socket.readyState !== WebSocket.OPEN || !clientID) return; // Precisa de clientID
        const message = { type: 'subscribe', topic: topic };
        socket.send(JSON.stringify(message));
        log(`Pedido inscrição no tópico: ${topic}`);
    }


    // --- Botões ---
    document.getElementById('createBtn').onclick = () => {
      // -- CORREÇÃO: Usa isReady() sem argumento ou isReady(false) --
      if (!isReady()) return;
      const username = usernameInput.value.trim();
      if (!username) return alert('Insira um nome de utilizador.');
      // -- CORREÇÃO: Envia diretamente sem usar sendAuthMessage --
      const message = { type: 'publish', topic: 'auth.create_account', data: { username } };
      socket.send(JSON.stringify(message));
      log(`Enviado (auth.create_account): ${JSON.stringify({ username })}`);
    };

    document.getElementById('loginBtn').onclick = () => {
      // -- CORREÇÃO: Usa isReady() sem argumento ou isReady(false) --
      if (!isReady()) return;
      const username = usernameInput.value.trim();
      if (!username) return alert('Insira um nome de utilizador.');
      // -- CORREÇÃO: Envia diretamente sem usar sendAuthMessage --
      const message = { type: 'publish', topic: 'auth.login', data: { username } };
      socket.send(JSON.stringify(message));
      log(`Enviado (auth.login): ${JSON.stringify({ username })}`);
    };

    // Mantenha a verificação de login para as ações que precisam dele
    document.getElementById('logoutBtn').onclick = () => {
      // Usa sendAuthMessage pois requer login prévio para saber quem deslogar
      sendAuthMessage('auth.logout', {});
      playerID = null; // Limpa localmente
      log('Solicitado logout (Player ID local limpo).');
    };

    document.getElementById('openPackBtn').onclick = () => {
       // Usa sendAuthMessage pois requer playerID
       sendAuthMessage('package.open_pack', { player_id: playerID });
    };

    document.getElementById('tradeBtn').onclick = () => {
        // Usa sendAuthMessage pois requer playerID
        const cardA = cardAInput.value.trim();
        const playerB = playerBInput.value.trim();
        const cardB = cardBInput.value.trim();

        if (!cardA || !playerB || !cardB) {
            alert('Preencha todos os campos da troca.');
            return;
        }

        sendAuthMessage('trade.request_trade', {
            card_a_id: cardA,
            player_b_id: playerB,
            card_b_id: cardB
        });
    };

  </script>
</body>
</html>